@page "/userinfo"
@inject NavigationManager NavManager
@inject IModalService Modal
@inject ISessionStorageService Storage
@attribute [Authorize]

<div class="col-md-auto">
    <h3><b>User Info</b></h3>
    <hr />
    <EditForm Model="@user">
        <DataAnnotationsValidator />
        <div class="form-group">
            <label for="Name">Name:</label>
            <InputText class="@InputStyleClass" disabled="@IsEditModeDisabled" @bind-Value="user.FirstName" />
        </div>
        <div class="form-group">
            <label for="Surname">Surname:</label>
            <InputText class="@InputStyleClass" disabled="@IsEditModeDisabled" @bind-Value="user.LastName" />
        </div>
        <div class="form-group">
            <label for="Birthday">Birthday:</label>
            <InputDate class="@InputStyleClass" disabled="@IsEditModeDisabled" @bind-Value="@user.Birthday" />
        </div>
        <div class="form-group">
            <label for="Email">Email:</label>
            <InputText class="@InputStyleClass" disabled="true" @bind-Value="@user.Email" />
        </div>
        <div class="form-group" style="@(IsPasswordBeingChanged ? "" : "height: 0; color: transparent")">
            <label for="OldPassword">Enter old password: </label>
            <InputText type="@(IsPasswordBeingChanged ? "password" : "hidden")" class="@InputStyleClass" disabled="@(!IsPasswordBeingChanged)" @bind-Value="@user.OldPassword" />
        </div>
        <div class="form-group" style="@(IsPasswordBeingChanged ? "" : "height: 0; color: transparent")">
            <label for="NewPassword">Enter new password: </label>
            <InputText type="@(IsPasswordBeingChanged ? "password" : "hidden")" class="@InputStyleClass" disabled="@(!IsPasswordBeingChanged)" @bind-Value="@user.NewPassword" />
        </div>
        <br />
        <input type="@(IsEditModeDisabled ? "hidden" : "button")" @onclick="@ChangePasswordClickHandler" class="form-control col-3 button btn-primary" value="@(IsPasswordBeingChanged ? "Cancel changing password" : "Change password")" />
        <br />
        <ValidationSummary />
        <h4 style="display:@(ErrorOccured ? "block" : "hidden"); color:red">@ErrorMessage</h4>
        <input type="button" @onclick="@EditInfoClickHandler" class="form-control col-3 button btn-primary" value="@(IsEditModeDisabled ? "Edit" : "Save changes")" />
    </EditForm>
</div>

@code {
    public bool IsEditModeDisabled { get; set; }
    public bool IsPasswordBeingChanged { get; set; }
    public bool PopupVisible { get; set; }
    public string ErrorMessage { get; set; }
    public string InputStyleClass { get; set; }
    public bool ErrorOccured { get; set; }
    private UserInfoViewModel user;
    private UserToken userToken;

    private async Task EditInfoClickHandler()
    {
        if (IsEditModeDisabled)
        {
            IsEditModeDisabled = false;
            InputStyleClass = "form-control col-3";
        }
        else
        {
            try
            {
                var userInfo = new UserInfoRequest()
                {
                    UserId = userToken.UserId,
                    Email = user.Email,
                    FirstName = user.FirstName,
                    LastName = user.LastName,
                    Birthday = user.Birthday
                };

                var request = new EditUserRequest()
                {
                    UserInfo = userInfo,
                    PasswordRequest = null
                };

                if (IsPasswordBeingChanged)
                {
                    var passwordRequest = new PasswordChangeRequest()
                    {
                        OldPassword = user.OldPassword,
                        NewPassword = user.NewPassword
                    };

                    request.PasswordRequest = passwordRequest;
                }

                await UserEditor.EditUser(userToken, request);

                await UpdateUserModel();
            }
            catch (Exception e) when (
                e is ForbiddenException ||
                e is NotFoundException ||
                e is ValidationException)
            {
                ErrorMessage = e.Message;
                ErrorOccured = true;
            }

            Modal.Show<Modals.ChangesSavedModal>("Changes saved");
            IsEditModeDisabled = true;
            IsPasswordBeingChanged = false;
        }
    }

    private void ChangePasswordClickHandler()
    {
        IsPasswordBeingChanged ^= true;
    }

    private async Task UpdateUserModel()
    {
        try
        {
            var requestResult = await UserGetter.GetUserById(userToken);

            user = new UserInfoViewModel()
            {
                FirstName = requestResult.FirstName,
                LastName = requestResult.LastName,
                Birthday = requestResult.Birthday,
                Email = requestResult.Email
            };
        }
        catch (NotFoundException)
        {
            ErrorMessage = "Unable to get user information";
        }
        catch (Exception)
        {
            ErrorMessage = "Error occured";
            ErrorOccured = true;
        }
    }

    protected override void OnInitialized()
    {
        userToken = new UserToken();
        user = new UserInfoViewModel();
        ErrorOccured = false;
        ErrorMessage = "";
        PopupVisible = false;
        IsEditModeDisabled = true;
        IsPasswordBeingChanged = false;
        InputStyleClass = "input-group-text";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        userToken.UserId = await Storage.GetItemAsync<Guid>("id");
        userToken.Body = await Storage.GetItemAsync<string>("token");

        if (IsEditModeDisabled && string.IsNullOrEmpty(user.FirstName))
        {
            await UpdateUserModel();
            StateHasChanged();
        }
    }
}